<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hedera Token Holder Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0d1117;
      --surface:   #161b22;
      --border:    #30363d;
      --accent:    #2f81f7;
      --accent-dim:#1f6feb44;
      --text:      #e6edf3;
      --muted:     #8b949e;
      --green:     #3fb950;
      --red:       #f85149;
      --row-hover: #1c2128;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    /* ── Header ── */
    header {
      text-align: center;
      margin-bottom: 2.5rem;
    }
    header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    header h1 span { color: var(--accent); }
    .beta-badge {
      display: inline-block;
      font-size: 0.55rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #d29922;
      background: #d2992220;
      border: 1px solid #d2992255;
      border-radius: 4px;
      padding: 2px 6px;
      vertical-align: middle;
      margin-left: 0.5rem;
      position: relative;
      top: -3px;
    }
    header p {
      color: var(--muted);
      margin-top: 0.4rem;
      font-size: 0.9rem;
    }

    /* ── Search bar ── */
    .search-wrap {
      max-width: 640px;
      margin: 0 auto 2rem;
      display: flex;
      gap: 0.6rem;
    }
    .search-wrap input {
      flex: 1;
      padding: 0.65rem 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.15s;
    }
    .search-wrap input:focus { border-color: var(--accent); }
    .search-wrap input::placeholder { color: var(--muted); }
    .search-wrap button {
      padding: 0.65rem 1.4rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
      white-space: nowrap;
    }
    .search-wrap button:hover { opacity: 0.88; }
    .search-wrap button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ── Network toggle ── */
    .network-toggle {
      max-width: 640px;
      margin: -1rem auto 1.5rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .network-toggle span { font-size: 0.8rem; color: var(--muted); }
    .network-toggle label {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
      font-size: 0.82rem;
      color: var(--muted);
    }
    .network-toggle input[type="radio"] { accent-color: var(--accent); }
    .network-toggle label:has(input:checked) { color: var(--text); }

    /* ── Token info card ── */
    #token-info {
      max-width: 860px;
      margin: 0 auto 1.5rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.1rem 1.4rem;
      display: none;
      gap: 1.2rem;
      flex-wrap: wrap;
    }
    #token-info.visible { display: flex; }
    .info-block { flex: 1; min-width: 130px; }
    .info-block .label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); margin-bottom: 0.25rem; }
    .info-block .value { font-size: 1rem; font-weight: 600; word-break: break-all; }
    .info-block .value.mono { font-family: "SFMono-Regular", Consolas, monospace; }

    /* ── Status / error ── */
    #status {
      max-width: 860px;
      margin: 0 auto 1rem;
      font-size: 0.88rem;
      min-height: 1.4rem;
      text-align: center;
    }
    #status.error { color: var(--red); }
    #status.loading { color: var(--muted); }
    #status.ok { color: var(--green); }

    /* ── Spinner ── */
    .spinner {
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Table wrapper ── */
    .table-wrap {
      max-width: 860px;
      margin: 0 auto;
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
    }
    thead th {
      background: var(--surface);
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.72rem;
      letter-spacing: 0.06em;
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
    }
    thead th.right { text-align: right; }
    tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--row-hover); }
    tbody td { padding: 0.7rem 1rem; vertical-align: middle; }
    tbody td.right { text-align: right; }
    tbody td.mono { font-family: "SFMono-Regular", Consolas, monospace; font-size: 0.84rem; }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px; height: 28px;
      border-radius: 50%;
      background: var(--bg);
      border: 1px solid var(--border);
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--muted);
    }
    .rank-badge.gold   { border-color: #d29922; color: #d29922; background: #d2992215; }
    .rank-badge.silver { border-color: #8b949e; color: #c9d1d9; background: #8b949e15; }
    .rank-badge.bronze { border-color: #b45309; color: #e3973a; background: #b4530915; }

    /* Account cell */
    .acct-cell { display: flex; align-items: center; gap: 0.5rem; }
    .acct-cell a {
      color: var(--accent);
      text-decoration: none;
      font-family: "SFMono-Regular", Consolas, monospace;
      font-size: 0.84rem;
    }
    .acct-cell a:hover { text-decoration: underline; }
    .copy-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--muted);
      cursor: pointer;
      font-size: 0.72rem;
      padding: 1px 5px;
      transition: color 0.1s, border-color 0.1s;
    }
    .copy-btn:hover { color: var(--text); border-color: var(--muted); }
    .copy-btn.copied { color: var(--green); border-color: var(--green); }

    /* Share bar */
    .share-bar {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.78rem;
    }
    .share-bar-fill {
      width: 80px;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }
    .share-bar-fill-inner {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      transition: width 0.3s;
    }

    /* ── Empty / placeholder ── */
    .empty-state {
      max-width: 860px;
      margin: 0 auto;
      text-align: center;
      padding: 4rem 1rem;
      color: var(--muted);
    }
    .empty-state svg { opacity: 0.25; margin-bottom: 1rem; }
    .empty-state p { font-size: 0.9rem; }

    /* ── Top Tokens Section ── */
    .top-tokens-section {
      max-width: 860px;
      margin: 0 auto 2rem;
    }
    .top-tokens-hdr {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.6rem;
    }
    .top-tokens-hdr .section-label {
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }
    .top-tokens-hdr .refresh-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--muted);
      cursor: pointer;
      font-size: 0.78rem;
      padding: 2px 8px;
      transition: color 0.1s, border-color 0.1s;
    }
    .top-tokens-hdr .refresh-btn:hover { color: var(--text); border-color: var(--muted); }
    .top-tokens-hdr .refresh-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .top-tokens-scroll {
      display: flex;
      gap: 0.55rem;
      overflow-x: auto;
      padding-bottom: 0.3rem;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    .token-card {
      flex: 0 0 auto;
      width: 148px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.7rem 0.75rem 0.6rem;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      user-select: none;
    }
    .token-card:hover { border-color: var(--accent); background: var(--row-hover); }
    .token-card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 0.15rem;
    }
    .tc-symbol { font-weight: 700; font-size: 0.88rem; color: var(--text); }
    .tc-rank   { font-size: 0.65rem; color: var(--muted); font-weight: 600; padding-top: 1px; }
    .tc-name   { font-size: 0.68rem; color: var(--muted); margin-bottom: 0.45rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tc-spark  { margin-bottom: 0.45rem; line-height: 0; border-radius: 3px; overflow: hidden; }
    .tc-price  { font-size: 0.82rem; font-weight: 600; color: var(--text); margin-bottom: 0.18rem; }
    .tc-change { font-size: 0.72rem; font-weight: 700; }
    .tc-change.up   { color: var(--green); }
    .tc-change.down { color: var(--red); }
    .tc-vol    { font-size: 0.64rem; color: var(--muted); margin-top: 0.1rem; }
    .top-tokens-msg {
      display: flex; align-items: center; gap: 0.5rem;
      font-size: 0.82rem; color: var(--muted); padding: 1.2rem 0;
    }
    .top-tokens-err { font-size: 0.8rem; color: var(--red); padding: 0.75rem 0; }
    .top-tokens-source { font-size: 0.67rem; color: var(--muted); margin-top: 0.35rem; text-align: right; }
    .top-tokens-source a { color: var(--muted); text-decoration: underline; }

    /* ── Footer ── */
    footer {
      text-align: center;
      margin-top: 3rem;
      font-size: 0.78rem;
      color: var(--muted);
    }
    footer a { color: var(--muted); text-decoration: underline; }
  </style>
</head>
<body>

<header>
  <h1>Hedera <span>Token Holder</span> Dashboard<span class="beta-badge">Beta</span></h1>
  <p>Query the top 50 wallets holding any HTS token</p>
</header>

<section class="top-tokens-section" id="top-tokens-section">
  <div class="top-tokens-hdr">
    <span class="section-label">Top 10 HTS Tokens &middot; 24h Volume</span>
    <button class="refresh-btn" id="top-tokens-refresh" onclick="loadTopTokens()">&#x21bb; Refresh</button>
  </div>
  <div id="top-tokens-scroll" class="top-tokens-scroll">
    <div class="top-tokens-msg"><span class="spinner"></span>Loading…</div>
  </div>
  <div class="top-tokens-source">Data via <a href="https://www.coingecko.com" target="_blank" rel="noopener">CoinGecko</a> &middot; sparklines show 7-day hourly price</div>
</section>

<div class="network-toggle">
  <span>Network:</span>
  <label><input type="radio" name="network" value="mainnet" checked /> Mainnet</label>
  <label><input type="radio" name="network" value="testnet" /> Testnet</label>
</div>

<div class="search-wrap">
  <input
    id="token-input"
    type="text"
    placeholder="Enter token ID  (e.g. 0.0.1234567)"
    autocomplete="off"
    spellcheck="false"
  />
  <button id="query-btn" onclick="queryToken()">Query</button>
</div>

<div id="status"></div>

<div id="token-info">
  <div class="info-block">
    <div class="label">Token Name</div>
    <div class="value" id="info-name">—</div>
  </div>
  <div class="info-block">
    <div class="label">Symbol</div>
    <div class="value" id="info-symbol">—</div>
  </div>
  <div class="info-block">
    <div class="label">Token ID</div>
    <div class="value mono" id="info-id">—</div>
  </div>
  <div class="info-block">
    <div class="label">Decimals</div>
    <div class="value" id="info-decimals">—</div>
  </div>
  <div class="info-block">
    <div class="label">Total Supply</div>
    <div class="value" id="info-supply">—</div>
  </div>
  <div class="info-block">
    <div class="label">Type</div>
    <div class="value" id="info-type">—</div>
  </div>
</div>

<div id="table-container">
  <div class="empty-state" id="empty-state">
    <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M17 11A6 6 0 1 1 5 11a6 6 0 0 1 12 0z"/>
    </svg>
    <p>Enter a Hedera token ID above and click <strong>Query</strong></p>
  </div>
</div>

<footer>
  Data sourced from the <a href="https://docs.hedera.com/hedera/sdks-and-apis/rest-api" target="_blank" rel="noopener">Hedera Mirror Node REST API</a>.
  View on <a id="hashscan-link" href="#" target="_blank" rel="noopener">HashScan</a>.
</footer>

<script>
  const MIRROR_NODES = {
    mainnet: 'https://mainnet-public.mirrornode.hedera.com',
    testnet: 'https://testnet.mirrornode.hedera.com',
  };
  const HASHSCAN_BASE = {
    mainnet: 'https://hashscan.io/mainnet',
    testnet: 'https://hashscan.io/testnet',
  };

  function getNetwork() {
    return document.querySelector('input[name="network"]:checked').value;
  }

  function setStatus(msg, type = '') {
    const el = document.getElementById('status');
    el.className = type;
    el.innerHTML = msg;
  }

  function formatBalance(raw, decimals) {
    if (decimals === 0) return Number(raw).toLocaleString();
    const divisor = Math.pow(10, decimals);
    const val = Number(raw) / divisor;
    return val.toLocaleString(undefined, { maximumFractionDigits: decimals });
  }

  function rankBadgeClass(i) {
    if (i === 0) return 'gold';
    if (i === 1) return 'silver';
    if (i === 2) return 'bronze';
    return '';
  }

  async function copyText(text, btn) {
    try {
      await navigator.clipboard.writeText(text);
      btn.textContent = 'copied';
      btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'copy'; btn.classList.remove('copied'); }, 1500);
    } catch {
      btn.textContent = '!err';
    }
  }

  function buildTable(balances, tokenDecimals, totalSupply, network) {
    const hashscan = HASHSCAN_BASE[network];
    const top50 = balances.slice(0, 50);
    const totalSupplyNum = Number(totalSupply);

    let rows = '';
    top50.forEach((entry, i) => {
      const { account, balance } = entry;
      const decimals = tokenDecimals;
      const fmt = formatBalance(balance, decimals);
      const pct = totalSupplyNum > 0
        ? ((Number(balance) / totalSupplyNum) * 100).toFixed(4)
        : '—';
      const badgeCls = rankBadgeClass(i);

      rows += `
        <tr>
          <td><span class="rank-badge ${badgeCls}">${i + 1}</span></td>
          <td>
            <div class="acct-cell">
              <a href="${hashscan}/account/${account}" target="_blank" rel="noopener">${account}</a>
              <button class="copy-btn" onclick="copyText('${account}', this)">copy</button>
            </div>
          </td>
          <td class="right mono">${fmt}</td>
          <td class="right">
            <div class="share-bar">
              <span>${pct}%</span>
              <div class="share-bar-fill">
                <div class="share-bar-fill-inner" style="width:${Math.min(parseFloat(pct)||0, 100)}%"></div>
              </div>
            </div>
          </td>
        </tr>`;
    });

    return `
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:52px">#</th>
              <th>Wallet Address</th>
              <th class="right">Balance</th>
              <th class="right">% of Supply</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  }

  async function queryToken() {
    const raw = document.getElementById('token-input').value.trim();
    if (!raw) { setStatus('Please enter a token ID.', 'error'); return; }

    // Validate rough format
    if (!/^\d+\.\d+\.\d+$/.test(raw)) {
      setStatus('Invalid token ID format. Expected format: 0.0.XXXXXXX', 'error');
      return;
    }

    const network = getNetwork();
    const base = MIRROR_NODES[network];
    const hashscan = HASHSCAN_BASE[network];
    const btn = document.getElementById('query-btn');
    btn.disabled = true;

    // Hide previous results
    document.getElementById('token-info').classList.remove('visible');
    document.getElementById('table-container').innerHTML = '';
    setStatus('<span class="spinner"></span>Fetching token info…', 'loading');

    try {
      // 1. Fetch token metadata
      const tokenRes = await fetch(`${base}/api/v1/tokens/${raw}`);
      if (!tokenRes.ok) {
        if (tokenRes.status === 404) throw new Error(`Token ${raw} not found on ${network}.`);
        throw new Error(`Mirror node error ${tokenRes.status} while fetching token info.`);
      }
      const tokenData = await tokenRes.json();

      const decimals = parseInt(tokenData.decimals ?? '0', 10);
      const totalSupply = tokenData.total_supply ?? '0';
      const adjustedSupply = formatBalance(totalSupply, decimals);

      // Populate info card
      document.getElementById('info-name').textContent    = tokenData.name    || '—';
      document.getElementById('info-symbol').textContent  = tokenData.symbol  || '—';
      document.getElementById('info-id').textContent      = tokenData.token_id || raw;
      document.getElementById('info-decimals').textContent = decimals;
      document.getElementById('info-supply').textContent  = adjustedSupply;
      document.getElementById('info-type').textContent    = tokenData.type    || '—';
      document.getElementById('token-info').classList.add('visible');

      // Update hashscan footer link
      document.getElementById('hashscan-link').href = `${hashscan}/token/${raw}`;

      // 2. Paginate through ALL holders, sort by balance desc, take top 50.
      //    The Mirror Node orders by account ID — there is no server-side sort by
      //    balance — so we must collect every page and sort client-side.
      const PAGE_SIZE = 100;          // max allowed by the API
      const PAGE_CAP  = 200;          // safety cap: 200 × 100 = 20 000 holders
      let allBalances = [];
      let nextUrl = `${base}/api/v1/tokens/${raw}/balances?limit=${PAGE_SIZE}`;
      let pagesFetched = 0;
      let cappedEarly = false;

      while (nextUrl) {
        pagesFetched++;
        setStatus(
          `<span class="spinner"></span>Fetching holders… page ${pagesFetched} (${allBalances.length} collected)`,
          'loading'
        );

        const balRes = await fetch(nextUrl);
        if (!balRes.ok) {
          throw new Error(`Mirror node error ${balRes.status} while fetching balances.`);
        }
        const balData = await balRes.json();
        const page = balData.balances ?? [];
        allBalances = allBalances.concat(page);

        const nextPath = balData.links?.next ?? null;
        nextUrl = nextPath ? `${base}${nextPath}` : null;

        if (pagesFetched >= PAGE_CAP && nextUrl) {
          cappedEarly = true;
          nextUrl = null;
        }
      }

      // Sort all holders by balance descending, then slice top 50
      allBalances.sort((a, b) => {
        const diff = BigInt(b.balance) - BigInt(a.balance);
        return diff > 0n ? 1 : diff < 0n ? -1 : 0;
      });
      const balances = allBalances.slice(0, 50);

      if (balances.length === 0) {
        document.getElementById('table-container').innerHTML =
          `<div class="empty-state"><p>No holder data found for this token.</p></div>`;
        setStatus(`Token found, but no balance data available.`, 'ok');
        return;
      }

      // Render table
      document.getElementById('table-container').innerHTML =
        buildTable(balances, decimals, totalSupply, network);

      const cappedNote = cappedEarly
        ? ` <span style="color:var(--muted)">(sampled first ${PAGE_CAP * PAGE_SIZE} holders — token has more)</span>`
        : '';
      setStatus(
        `Top 50 of <strong>${allBalances.length.toLocaleString()}</strong> total holders for <strong>${tokenData.name || raw}</strong> (${tokenData.symbol || ''})${cappedNote}`,
        'ok'
      );

    } catch (err) {
      setStatus(err.message, 'error');
      document.getElementById('table-container').innerHTML =
        `<div class="empty-state"><p>${err.message}</p></div>`;
    } finally {
      btn.disabled = false;
    }
  }

  // ── Top Tokens by 24h Volume (CoinGecko) ───────────────────────────────────
  const COINGECKO = 'https://api.coingecko.com/api/v3';

  function fmtUsd(v) {
    if (v === null || v === undefined || isNaN(v)) return '—';
    if (v >= 1e9) return '$' + (v / 1e9).toFixed(2) + 'B';
    if (v >= 1e6) return '$' + (v / 1e6).toFixed(2) + 'M';
    if (v >= 1e3) return '$' + (v / 1e3).toFixed(1) + 'K';
    if (v >= 1)   return '$' + v.toFixed(2);
    return '$' + v.toPrecision(4);
  }

  function fmtPct(v) {
    if (v === null || v === undefined || isNaN(v)) return '—';
    return (v >= 0 ? '▲ +' : '▼ ') + Math.abs(v).toFixed(2) + '%';
  }

  function buildSparkSVG(prices, isPos) {
    const color = isPos ? '#3fb950' : '#f85149';
    const W = 136, H = 36;
    if (!prices || prices.length < 2) {
      const y1 = H / 2, y2 = isPos ? H * 0.3 : H * 0.7;
      return `<svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
        <line x1="0" y1="${y1}" x2="${W}" y2="${y2}" stroke="${color}" stroke-width="1.8" stroke-linecap="round" opacity="0.9"/>
      </svg>`;
    }
    const min = Math.min(...prices), max = Math.max(...prices);
    const range = max - min || 1;
    const pad = 3;
    const pts = prices.map((p, i) => {
      const x = (i / (prices.length - 1)) * W;
      const y = H - pad - ((p - min) / range) * (H - pad * 2);
      return [x.toFixed(1), y.toFixed(1)];
    });
    const polyline = pts.map(p => p.join(',')).join(' ');
    const fillPts = `${pts[0][0]},${H} ` + polyline + ` ${pts[pts.length - 1][0]},${H}`;
    const uid = 'sg' + Math.random().toString(36).slice(2, 7);
    return `<svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
      <defs>
        <linearGradient id="${uid}" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="${color}" stop-opacity="0.3"/>
          <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
        </linearGradient>
      </defs>
      <polygon points="${fillPts}" fill="url(#${uid})"/>
      <polyline points="${polyline}" fill="none" stroke="${color}" stroke-width="1.8" stroke-linejoin="round" stroke-linecap="round"/>
    </svg>`;
  }

  async function loadTopTokens() {
    const scroll = document.getElementById('top-tokens-scroll');
    const btn    = document.getElementById('top-tokens-refresh');
    scroll.innerHTML = '<div class="top-tokens-msg"><span class="spinner"></span>Loading…</div>';
    if (btn) btn.disabled = true;

    try {
      const res = await fetch(
        `${COINGECKO}/coins/markets?vs_currency=usd&category=hedera-ecosystem` +
        `&order=volume_desc&per_page=10&page=1&sparkline=true&price_change_percentage=24h`
      );
      if (res.status === 429) throw new Error('Rate limited — try again shortly');
      if (!res.ok) throw new Error(`CoinGecko API ${res.status}`);
      const tokens = await res.json();
      if (!tokens.length) throw new Error('No token data returned');

      scroll.innerHTML = tokens.map((t, i) => {
        const chg    = t.price_change_percentage_24h ?? 0;
        const isPos  = chg >= 0;
        // Subsample 168 hourly points → ~24 for a clean sparkline
        const raw    = t.sparkline_in_7d?.price ?? [];
        const step   = Math.max(1, Math.floor(raw.length / 24));
        const prices = raw.filter((_, j) => j % step === 0);
        const spark  = buildSparkSVG(prices, isPos);
        return `
          <div class="token-card" onclick="useTopToken('${t.id}')" title="Click to query ${t.name}">
            <div class="token-card-top">
              <span class="tc-symbol">${t.symbol.toUpperCase()}</span>
              <span class="tc-rank">#${i + 1}</span>
            </div>
            <div class="tc-name">${t.name}</div>
            <div class="tc-spark">${spark}</div>
            <div class="tc-price">${fmtUsd(t.current_price)}</div>
            <div class="tc-change ${isPos ? 'up' : 'down'}">${fmtPct(chg)}</div>
            <div class="tc-vol">${fmtUsd(t.total_volume)} vol</div>
          </div>`;
      }).join('');

    } catch (err) {
      scroll.innerHTML = `<span class="top-tokens-err">Could not load: ${err.message}</span>`;
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  async function useTopToken(coinId) {
    if (!coinId) return;
    try {
      // Resolve the Hedera token ID (0.0.XXXXXX) from CoinGecko coin details
      const res = await fetch(
        `${COINGECKO}/coins/${coinId}?localization=false&tickers=false&market_data=false&community_data=false&developer_data=false`
      );
      if (!res.ok) return;
      const data = await res.json();
      let htsId = data.platforms?.['hedera-hashgraph'];
      if (!htsId) return;

      // CoinGecko often returns an EVM hex address instead of 0.0.X format.
      // The Mirror Node accepts EVM addresses and returns the native token_id.
      if (/^0x[0-9a-f]{40}$/i.test(htsId)) {
        const mRes = await fetch(`${MIRROR_NODES.mainnet}/api/v1/tokens/${htsId}`);
        if (!mRes.ok) return;
        htsId = (await mRes.json()).token_id;
      }

      if (htsId && /^\d+\.\d+\.\d+$/.test(htsId)) {
        document.getElementById('token-input').value = htsId;
        queryToken();
      }
    } catch { /* clicking is a bonus; silently ignore failures */ }
  }

  loadTopTokens();

  // Allow Enter key to trigger query
  document.getElementById('token-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') queryToken();
  });
</script>
</body>
</html>
